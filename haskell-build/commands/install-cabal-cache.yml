parameters:
  github-token:
    description: Github OAuth2 token to use when making Github API requests
    type: string
    default: ${GITHUB_TOKEN}
  tag:
    description: |
      Cache tool version (tag name or "latest").  Should be at least v1.0.0.1.
      For list of tags see https://github.com/haskell-works/cabal-cache/tags

    type: string
steps:
  - run:
      name: Install binary cache tool (cabal-cache)
      command: |
        if [ "<<parameters.github-token>>" = "" ]; then
          GITHUB_OAUTH_TOKEN_HEADER=""
        else
          echo "Using supplied Github token"
          GITHUB_OAUTH_TOKEN_HEADER="-H 'Authorization: token <<parameters.github-token>>'"
        fi

        if [ "<< parameters.tag >>" = "latest" ]; then
          curl -s --retry 3 $GITHUB_OAUTH_TOKEN_HEADER -X GET https://api.github.com/repos/haskell-works/cabal-cache/releases/latest > /tmp/releases.txt
          CACHE_TOOL_TAG=$(curl -s --retry 3 $GITHUB_OAUTH_TOKEN_HEADER -X GET https://api.github.com/repos/haskell-works/cabal-cache/releases/latest | jq -rc .tag_name)
        else
          CACHE_TOOL_TAG="<< parameters.tag >>"
        fi
        echo "Downloading: https://github.com/haskell-works/cabal-cache/releases/download/${CACHE_TOOL_TAG}/cabal-cache_${BUILD_ARCH}_${BUILD_OS_NAME}.tar.gz"
        curl -Ls https://github.com/haskell-works/cabal-cache/releases/download/${CACHE_TOOL_TAG}/cabal-cache_${BUILD_ARCH}_${BUILD_OS_NAME}.tar.gz | tar -xvz -C /tmp/
        cp /tmp/cabal-cache /usr/local/bin/
        cabal-cache version
