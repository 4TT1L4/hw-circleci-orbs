parameters:
  tag:
    description: |
      Cache tool version (tag name or "latest").  Should be at least v1.0.0.1.
      For list of tags see https://github.com/haskell-works/cabal-cache/tags

    type: string
steps:
  - run:
      name: Install binary cache tool (cabal-cache)
      command: |
        if [ "<< parameters.tag >>" = "latest" ]; then
          CACHE_TOOL_TAG=$(curl -s -X GET https://api.github.com/repos/haskell-works/cabal-cache/releases/latest | jq -rc .tag_name)
        else
          CACHE_TOOL_TAG="<< parameters.tag >>"
        fi
        echo "Downloading: https://github.com/haskell-works/cabal-cache/releases/download/${CACHE_TOOL_TAG}/cabal-cache_${BUILD_ARCH}_${BUILD_OS_NAME}.tar.gz"
        curl -Ls https://github.com/haskell-works/cabal-cache/releases/download/${CACHE_TOOL_TAG}/cabal-cache_${BUILD_ARCH}_${BUILD_OS_NAME}.tar.gz | tar -xvz -C /tmp/
        sudo cp /tmp/cabal-cache /root/.local/bin/
        cabal-cache version
