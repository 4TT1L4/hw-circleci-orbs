version: 2.1

description: Builds a Haskell application using cabal new-*.

executors:
  ghc-844:
    docker:
      - image: quay.io/haskell_works/ghc-8.4.4:latest
  ghc-863:
    docker:
      - image: quay.io/haskell_works/ghc-8.6.3:latest

commands:
  override-ghc:
    steps:
      - run:
          name: Override GHC version
          command: |
            test -f cabal.project || echo 'packages: .' > cabal.project
            _ghc_ver=$(ghc --numeric-version)
            sed -i '/^with-compiler:/{h;s/:.*/: ghc-'"$_ghc_ver"'/};${x;/^$/{s//with-compiler: ghc-'"$_ghc_ver"'/;H};x}' cabal.project

  set-project-env:
    steps:
      - run:
          name: Setting project environment
          command: |
            mkdir -p ./build
            BUILD_DIST="./dist-newstyle/build"
            BUILD_CABAL_VER=$(cabal --numeric-version)
            BUILD_GHC_VER=$(cat cabal.project | grep 'with-compiler:' | head -n 1 | tr -s ' ' | cut -d' ' -f2 | cut -d'-' -f2)
            if [ "$BUILD_GHC_VER" = "" ]; then BUILD_GHC_VER=$(ghc -- --numeric-version); fi
            BUILD_PROJECT_NAME=$(cat *.cabal | grep '^name:' | head -n 1 | cut -d : -f 2 | xargs)
            BUILD_PROJECT_VERSION=$(cat *.cabal | grep -e "^version" | tr -s " " | cut -d' ' -f2)
            BUILD_EXE_NAME=$(cat *.cabal | grep 'executable ' | tr -s ' ' | cut -d' ' -f2)
            BUILD_ARCH=$(uname -m)
            BUILD_OS_NAME=$(uname -s | tr '[:upper:]' '[:lower:]')
            BUILD_OS_SUFFIX=$BUILD_OS_NAME
            if [ "$BUILD_OS_SUFFIX" = "darwin" ]; then BUILD_OS_SUFFIX="osx"; fi

            echo "$BUILD_GHC_VER" > ./build/ghc-version.txt

            echo "export BUILD_CABAL_VER=$BUILD_CABAL_VER"              > ./build/project.env
            echo "export BUILD_GHC_VER=$BUILD_GHC_VER"                 >> ./build/project.env
            echo "export BUILD_ARCH=$BUILD_ARCH"                       >> ./build/project.env
            echo "export BUILD_OS_NAME=$BUILD_OS_NAME"                 >> ./build/project.env
            echo "export BUILD_OS_SUFFIX=$BUILD_OS_SUFFIX"             >> ./build/project.env
            echo "export BUILD_PROJECT_NAME=$BUILD_PROJECT_NAME"       >> ./build/project.env
            echo "export BUILD_PROJECT_VERSION=$BUILD_PROJECT_VERSION" >> ./build/project.env
            echo "export BUILD_EXE_NAME=$BUILD_EXE_NAME"               >> ./build/project.env


            cat ./build/project.env >> $BASH_ENV
            cat $BASH_ENV
            source $BASH_ENV

  copy-bin:
    steps:
      - run:
          name: Copying executable
          command: |
            _os_suffix=$OS_NAME
            if [ "$_os_suffix" = "darwin" ]; then _os_suffix="osx"; fi
            _bin_path="./dist-newstyle/build/$BUILD_ARCH-$BUILD_OS_NAME/ghc-$BUILD_GHC_VER/$BUILD_PROJECT_NAME-$BUILD_PROJECT_VERSION/x/$BUILD_EXE_NAME/build/$BUILD_EXE_NAME/$BUILD_EXE_NAME"
            echo "Exe path: $_bin_path"
            if [ -f "$_bin_path" ]; then
              mkdir -p ./build/dist
              cp $_bin_path ./build/dist
            fi
            ls --recursive ./build

  build:
    parameters:
      cabal_threads:
        description: Number of Cabal threads.
        type: integer
        default: 4
      cabal_file:
        type: string
        description: Cabal file name (including the .cabal extension)
      write_workspace:
        description: Boolean for whether or not to persist results to a workspace.
        type: boolean
        default: true

    steps:
      - override-ghc
      - set-project-env

      - restore_cache:
          keys:
            - dot-cabal-{{ checksum "./build/ghc-version.txt" }}-{{ checksum "cabal.project" }}-{{ checksum "cabal.project.freeze" }}-{{ checksum "<< parameters.cabal_file >>" }}
            - dot-cabal-{{ checksum "./build/ghc-version.txt" }}-{{ checksum "cabal.project" }}-{{ checksum "cabal.project.freeze" }}
            - dot-cabal-{{ checksum "./build/ghc-version.txt" }}

      - restore_cache:
          keys:
            - dist-{{ checksum "./build/ghc-version.txt" }}-{{ checksum "cabal.project" }}-{{ checksum "cabal.project.freeze" }}-{{ checksum "<< parameters.cabal_file >>" }}
            - dist-{{ checksum "./build/ghc-version.txt" }}-{{ checksum "cabal.project" }}

      - run: cabal new-update -j<<parameters.cabal_threads>>
      - run: cabal new-build --enable-tests --dependencies-only -j<<parameters.cabal_threads>>

      - save_cache:
          key: dot-cabal-{{ checksum "./build/ghc-version.txt" }}-{{ checksum "cabal.project" }}-{{ checksum "cabal.project.freeze" }}
          paths: [~/.cabal/packages, ~/.cabal/store]

      - save_cache:
          key: dot-cabal-{{ checksum "./build/ghc-version.txt" }}
          paths: [~/.cabal/packages, ~/.cabal/store]

      - run:
          name: Building project
          command: cabal new-build --enable-tests  --enable-benchmarks -j<<parameters.cabal_threads>>

      - save_cache:
          key: dist-{{ checksum "./build/ghc-version.txt" }}-{{ checksum "cabal.project" }}
          paths: [./dist-newstyle]

      - save_cache:
          key: dist-{{ checksum "./build/ghc-version.txt" }}-{{ checksum "cabal.project" }}-{{ checksum "cabal.project.freeze" }}-{{ checksum "<< parameters.cabal_file >>" }}
          paths: [./dist-newstyle]

      - when:
          condition: << parameters.write_workspace >>
          steps:
            - copy-bin
            - persist_to_workspace:
                root: .
                paths: [build]

jobs:
  build:
    parameters:
      cabal_threads:
        description: Number of Cabal threads.
        type: integer
        default: 4
      cabal_file:
        type: string
        description: Cabal file name (including the .cabal extension)
      executor:
        type: executor
        default: ghc-844
    executor: << parameters.executor >>
    steps:
      - checkout
      - run: git fetch --unshallow || true
      - build:
          cabal_threads: <<parameters.cabal_threads>>
          cabal_file: <<parameters.cabal_file>>
